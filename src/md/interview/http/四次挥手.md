## 四次挥手
- 断开连接服务端和客户端都可以主动发起。
> 建立一个连接需要三次握手，而终止一个连接要经过四次挥手（也有将四次挥手叫做四次握手的）。这由TCP的半关闭（half-close）造成的。所谓的半关闭，其实就是TCP提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力。客户端或服务器均可主动发起挥手动作。

### 以客户端发起断开为例
1. 客户端先发送FIN包生成客户端的seq序列号随后进入wait1状态，这是第一次挥手。
2. 服务端收到FIN包表示自己进入了关闭等待状态，然后向客户端使用ack验证，验证成功打上ACK标记，随后生成服务端的seq值发送给客户端，这是第二次挥手，服务端此时还可以发送未完成的数据。
3. 等待服务端所有任务操作完成之后服务端开始进入最后确认状态，向客户端发送FIN包，并且验证ack，使用客户端第一次的seq + 1去验证，验证成功打上ACK标记，并且生成一个新的序列号seq发送给客户端，这是第三次挥手。
4. 客户端收到之后进入超时等待状态2MSL(1-4分钟)，经过等待后客户端向服务端发送ACK包后关闭连接，而服务端收到信息验证完成ack成功之后打上ACk标记随后将关闭连接。


#### 为什么需要四次
> TCP连接时是同步的，但结束时是不同步的，当主动关闭方不会再主动发送数据，但仍然可以接收数据，此时处于半关闭状态。这样被动关闭方有足够的时间去处理以前没有处理完的数据，它可能还有一部分数据没发送出去需要处理，在此之后提出主动关闭连接。所以4次挥手的设计为连接双方都提供了一定的处理扫尾工作的时间，从而显的是必要的。

1. 当客户端发出FIN报文段时，只是表示客户端已经没有数据要发送了，客户端告诉服务端它的数据已经全部发送完毕了；但是这个时候客户端还是可以接受来服务端的数据；
2. 当服务端返回ACK报文段时，表示它已经知道客户端没有数据发送了，但是服务端还是可以发送数据到客户端的；
3. 当服务端也发送了FIN报文段时，这个时候就表示服务端也没有数据要发送了，就会告诉客户端我也没有数据要发送了。
4. 客户端收到 FIN 之后，一样发送一个 ACK 报文作为应答，之后彼此就会愉快的中断这次TCP连接。