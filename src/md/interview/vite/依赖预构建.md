## [依赖预构建](https://mp.weixin.qq.com/s/XmJLm0LJLJ-iSQuQZwH8kw)
### no-bundle
- vite在开发阶段提倡的是一个no-bundle的理念，不需要像webpack那样需要先将整个项目进行打包构建。但是no-bundle的理念只适合源代码部分(我们自己写的代码)，vite会将项目中的所有模块分为依赖与源码两部分。
- 依赖：指的是一些不会变动的一些模块，如node_modules中的第三方依赖，这部分代码vite会在启动本地服务之前使用esbuild进行预构建。esbuild使用Go编写，比使用JavaScript编写的打包器预构建依赖快10-100倍。
- 源码：指的是我们自己开发时写的那部分代码，这部分代码可能会经常变动，并且一般不会同时加载所有源代码。
- no-bundle是针对源码的，而预构建是针对第三方依赖的。
### [使用预构建的原因](https://mp.weixin.qq.com/s/lwjCQ5VsRCcFimLMNn3evA)
- commonJS与UMD兼容：因为vite在开发阶段主要是依赖浏览器原生ES模块化规范，所以无论是我们的源代码还是第三方依赖都得符合ESM的规范，但是目前并不是所有第三方依赖都有ESM的版本，所以需要对第三方依赖进行预编译，将它们转换成EMS规范的产物。
- 性能：为了提高后续页面的加载性能，vite将那些具有许多内部模块的ESM依赖项转换为单个模块。只需要发起一个HTTP请求，可以很大程度地提高加载性能。由于vite的预构建是基于性能优异的Esbuild来完成的，所以并不会造成明显的打包性能问题。
### 开启预构建
- vite默认开启了预构建，预构建产物会存放在：node_modules/.vite目录下，目录下有一个_metadata.json的文件，保存着已经预构建过的依赖信息。
- 对于预构建产物的请求，vite会设置为强缓存，有效时间为1年，对于有效期内的请求会直接使用缓存内容，只有HTTP强缓存时如果用户更新了依赖版本，在缓存过期之前，浏览器拿到的一直是旧版本的内容。所以vite对本地文件也设置了缓存判断，如果下面几个地方任意一个地方有变动，vite将会对依赖进行重新预构建。
  1. 项目依赖dependencies变更。
  2. 各种包管理器的lock文件变更。
  3. vite配置文件的optimizeDeps配置内容变更。
  4. NODE_ENV 的值。
- 如果出于某些原因想要强制Vite重新构建依赖项，可以在启动开发服务器时指定--force选项，或手动删除 node_modules/.vite 缓存目录。